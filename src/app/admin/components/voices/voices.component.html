<div class="toolbar">
    <div class="tabs">
        @for (t of statusTabs; track t.value) {
            <button
                class="tab"
                [class.active]="statusFilter() === t.value"
                (click)="setFilter(t.value)"
                type="button">
                {{ t.label }}
            </button>
        }
    </div>

    <div class="tools">
        <input
            class="search"
            type="search"
            placeholder="Search name, email, tags, note"
            (input)="onInput($event)"
            />

        <label class="limit">
            <span>Per page</span>
            <select (change)="setLimit(+$any($event.target).value)">
                <option [selected]="limit()===10" value="10">10</option>
                <option [selected]="limit()===20" value="20">20</option>
                <option [selected]="limit()===50" value="50">50</option>
            </select>
        </label>
    </div>
</div>

<div class="table-wrapper" [class.loading]="loading()">
    <table class="table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Created</th>
                <th>User</th>
                <th>Place / Credit</th>
                <th>Tags</th>
                <th>Image</th>
                <th>Status</th>
                <th class="actions">Actions</th>
            </tr>
        </thead>
        <tbody>
            @if (filtered().length === 0 && !loading()) {
                <tr>
                    <td colspan="8" class="empty">No items</td>
                </tr>
            } @else {
                @for (v of filtered(); track v.id; let i = $index) {
                    <tr>
                        <td>#{{ v.id }}</td>
                        <td>
                            <div class="mono">{{ v.createdAt | date:'yyyy-MM-dd HH:mm' }}</div>
                        </td>

                        <td>
                            <div class="main">{{ v.firstName || '—' }}</div>
                            <div class="sub mono">{{ v.email || '—' }}</div>
                        </td>

                        <td>
                            <div class="main">{{ v.location || '—' }}</div>
                            <div class="sub">{{ v.creditTo || '—' }}</div>
                        </td>

                        <td>
                            <div class="chips">
                                @for (t of (v.what || []); track t) {
                                    <span class="chip blue">{{ t }}</span>
                                }
                                @for (t of (v.express || []); track t) {
                                    <span class="chip green">{{ t }}</span>
                                }
                            </div>
                            @if (v.note) {
                                <div class="note" [title]="v.note">{{ v.note }}</div>
                            }
                        </td>

                        <td class="img-col">
                            @if (v.img) {
                              <div class="thumb-wrap">
                                <img
                                  class="thumb"
                                  [src]="v.img"
                                  alt="image #{{ v.id }}"
                                  (click)="openPreview(i)"
                                />
                                <button class="link" (click)="copyImg(v.img)" title="Copy URL" type="button">Copy</button>
                              </div>
                            } @else { — }
                          </td>

                        <td>
                            <span class="status" [class.pending]="v.status==='pending'"
                                              [class.approved]="v.status==='approved'"
                                              [class.rejected]="v.status==='rejected'">
                                {{ v.status }}
                            </span>
                        </td>

                        <td class="actions">
                            @for (a of statusActions; track a.value) {
                                <button
                                    class="btn sm"
                                    [class]="a.class"
                                    [disabled]="loading() || v.status===a.value"
                                    (click)="onStatusAction(v, a.value)"
                                    type="button">
                                    {{ a.label }}
                                </button>
                            }
                            @if (!userService.isModerator) {                           
                                <button
                                    class="btn sm ghost"
                                    [disabled]="loading()"
                                    (click)="onDelete(v)"
                                    type="button">
                                    Delete
                                </button>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>

    @if (loading()) {
        <div class="loader">Loading…</div>
    }
</div>

<div class="pager">
    <button
        class="btn"
        [disabled]="page()<=1 || loading()"
        (click)="prevPage()"
        type="button">
        Prev
    </button>
    <span class="mono">Page {{ page() }} / {{ totalPages() }}</span>
    <button
        class="btn"
        [disabled]="page()>=totalPages() || loading()"
        (click)="nextPage()"
        type="button">
        Next
    </button>
</div>


@if (previewOpen()) {
    <div
      class="preview-overlay"
      role="dialog"
      aria-modal="true"
      aria-label="Image preview"
      (click)="onOverlayBackdrop($event)"
      (keydown)="onOverlayKeydown($event)"
      tabindex="0">
      <div class="preview-content" (click)="$event.stopPropagation()">
        <button
            class="preview-close"
            (click)="closePreview()"
            aria-label="Close"
            type="button">
            ✕
        </button>
  
        <button
            class="nav left"
            (click)="prevPreview()"
            aria-label="Previous"
            type="button">‹</button>
            <div class="preview-tools">
                <button class="tool" type="button" (click)="rotateLeft()"  aria-label="Rotate left">⟲</button>
                <button class="tool" type="button" (click)="rotateRight()" aria-label="Rotate right">⟳</button>
                <span class="div"></span>
                <button class="tool" type="button" (click)="toggleFlipH()" [attr.aria-pressed]="flipH() ? 'true' : 'false'" aria-label="Flip horizontal">⇋</button>
                <button class="tool" type="button" (click)="toggleFlipV()" [attr.aria-pressed]="flipV() ? 'true' : 'false'" aria-label="Flip vertical">⇵</button>
                <span class="div"></span>
                <button class="tool ghost" type="button" (click)="resetTransform()" aria-label="Reset">Reset</button>
                <button class="tool primary" type="button" [disabled]="loading()" (click)="savePreviewTransform()" aria-label="Save">Save</button>
              </div>
              
              <img
                class="preview-img"
                [src]="currentPreviewImg()"
                [alt]="currentPreviewAlt()"
                [style.transform]="previewTransform()"
              />
        <button
            class="nav right"
            (click)="nextPreview()"
            aria-label="Next"
            type="button">›</button>
  
        <span
            class="status"
            [class.approved]="currentPreview()?.status === 'approved'"
            [class.pending]="currentPreview()?.status === 'pending'"
            [class.rejected]="currentPreview()?.status === 'rejected'">
            {{ currentPreview()?.status }}
        </span>
        <div class="preview-meta mono">
            #{{ currentPreview()?.id }} • {{ currentPreview()?.createdAt | date:'yyyy-MM-dd HH:mm' }} <br />
            {{ currentPreview()?.email }}
        </div>
      </div>
    </div>
  }
  
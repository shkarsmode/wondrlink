name: Check Azure DevOps Build Status

on:
  schedule:
    - cron: '*/5 * * * *'  # Проверяет билд каждые 5 минут
  workflow_dispatch:  # Позволяет запустить вручную

jobs:
  check-build-status:
    runs-on: ubuntu-latest

    steps:
      - name: Get latest build status from Azure DevOps
        id: get-build
        run: |
          BUILD_INFO=$(curl -s -u "${{ secrets.AZURE_USERNAME }}:${{ secrets.AZURE_PAT }}" \
            "https://dev.azure.com/fwollo/QApp/_apis/build/builds?definitions=26&api-version=7.1-preview.7" | jq '.value[0]')
          BUILD_ID=$(echo "$BUILD_INFO" | jq -r '.id')
          STATUS=$(echo "$BUILD_INFO" | jq -r '.status')
          RESULT=$(echo "$BUILD_INFO" | jq -r '.result')
          QUEUE_TIME=$(echo "$BUILD_INFO" | jq -r '.queueTime')
          FINISH_TIME=$(echo "$BUILD_INFO" | jq -r '.finishTime // "В процессе"')

          MESSAGE="🛠 Build #$BUILD_ID\n🔹 Status: *$STATUS*\n🔹 Result: *$RESULT*\n⏳ Started at: *$QUEUE_TIME*\n⏳ Finish time: *$FINISH_TIME*"

          echo "MESSAGE=$MESSAGE" >> $GITHUB_ENV

      - name: Send status to Telegram
        run: |
          curl -s -X POST "https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage" \
          -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
          -d parse_mode="Markdown" \
          -d text="${{ env.MESSAGE }}"

<h1>Update user</h1>

<form 
	*ngIf="user"
	[formGroup]="form" 
	(ngSubmit)="updateUser()" 
	[ngClass]="{'loading': isLoading}">

	<div class="d-flex">
		<div class="wrap-column">
			<div class="d-flex">
                <app-edit-user-card 
                    title="First name" 
                    formControlName="firstName">
                </app-edit-user-card>

                <app-edit-user-card 
                    title="Last Name" 
                    formControlName="lastName">
                </app-edit-user-card>
			</div>

            <app-edit-user-card 
                title="Email" 
                formControlName="email">
            </app-edit-user-card>
		
            <app-edit-user-card 
                title="Phone" 
                formControlName="phone">
            </app-edit-user-card>
		</div>

        <!-- ! Separate in another component -->
		<div class="card not-required">
			<div class="title">Avatar</div>
			<div class="content">
				<mat-chip-listbox aria-label="Upload image" >
					<mat-chip-option 
						(click)="toggleUploadImageType()"
						[selected]="isUploadImageSelected">
						Upload image
					</mat-chip-option>
					<mat-chip-option 
						(click)="toggleUploadImageType()"
						[selected]="!isUploadImageSelected">
						Image by url
					</mat-chip-option>
				</mat-chip-listbox>
				<div class="uploadOuter" *ngIf="isUploadImageSelected">
					<label for="uploadFile">
						Upload Image
					</label>
					<strong>OR</strong>
					<span class="dragBox" [ngClass]="{'draging': isDrag}">
						Drag and Drop image here
						<input 
							type="file" 
							(change)="dragNdrop($event)" 
							(dragover)="drag()" 
							(drop)="drop()"
							accept="image/png, image/gif, image/jpeg" id="uploadFile" />
					</span>
				</div>
				<div class="upload-by-url" *ngIf="!isUploadImageSelected">
					<input 
						type="text" 
						formControlName="picture"
						placeholder="https://picsum.photos/200/300.jpg">
					<button 
						type="button"
						[disabled]="picture.invalid || !isValidUrl"
						mat-stroked-button 
						(click)="handleUrlImage()">
						Preview Avatar
						<span class="material-symbols-outlined">
							preview
						</span>
					</button>
				</div>
				<div id="preview" #preview>
					<img *ngIf="user.avatar" [src]="user.avatar" [alt]="user.lastName">
				</div>
				<div class="error-message" *ngIf="!preview.innerHTML.includes('img')">
					Avatar wasn't uploaded
				</div>
			</div>
			
		</div>
	</div>

	<div class="d-flex">
        <!-- Separate in another component -->
		<div class="card">
			<div class="title">Role</div>
			<div class="content">
				<mat-form-field>
					<mat-label>Role</mat-label>
					<mat-select formControlName="role">
						<mat-option value="ADMIN">
							Admin
						</mat-option>
						<mat-option value="USER">
							User
						</mat-option>
					</mat-select>
				</mat-form-field>
			</div>
		</div>

		<div class="card" *ngIf="role.value !== userStatus.ADMIN">
			<div class="title">Type</div>
			<div class="content">
				<mat-form-field>
					<mat-label>Type</mat-label>
					<mat-select
						formControlName="type">
						<mat-option 
							[value]="userTypeEnum.None">
							None
						</mat-option>
						<mat-option 
							[value]="userTypeEnum.Patient">
                            {{ userTypeEnum.Patient }}
						</mat-option>
						<mat-option 
							[value]="userTypeEnum.Industry">
							{{ userTypeEnum.Industry }}
						</mat-option>
						<mat-option 
							[value]="userTypeEnum.Physician">
                            {{ userTypeEnum.Physician }}
						</mat-option>
					</mat-select>
				</mat-form-field>
			</div>
		</div>
	</div>

	<ng-container 
        *ngIf="role.value !== userStatus.ADMIN && type.value !== userTypeEnum.None">
        <app-edit-user-card 
            [title]="(type.value === userTypeEnum.None ? 'User' : type.value) + ' location'" 
            formControlName="location"
            [isRequired]="false">
        </app-edit-user-card>
        
        <ng-container *ngIf="type.value === userTypeEnum.Patient">
            <div class="d-flex">
                <div class="card not-required">
                    <div class="title">Patient situation</div> <!-- PatientSituationTypeEnum -->
                    <div class="content">
                        <mat-form-field>
                            <mat-label>Patient situation type</mat-label>
                            <mat-select formControlName="patientSituationType">
                                <mat-option 
                                    *ngFor="let type of Object.values(patientSituationTypeEnum)"
                                    [value]="type">
                                    {{ type }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                <div class="card not-required">
                    <div class="title">Disease category</div>
                    <div class="content">
                        <mat-form-field>
                            <mat-label>Disease category</mat-label>
                            <mat-select formControlName="diseaseCategory">
                                <mat-option 
                                    *ngFor="let category of diseaseCatogories" 
                                    [value]="category">
                                    {{ category }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
            </div>
            <div class="d-flex">
                <div class="card not-required">
                    <div class="title">Cancer Type</div>
                    <div class="content">
                        <mat-form-field>
                            <mat-label>Patient situation type</mat-label>
                            <mat-select formControlName="cancerType">
                                <mat-option 
                                    *ngFor="let type of cancerTypeEnum" 
                                    [value]="type">
                                    {{ type }}
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                <div class="card not-required">
                    <div class="title">Disease details</div>
                    <div class="content">
                        <textarea 
                            type="text"
                            rows="5" 
                            formControlName="diseaseDetails">
                        </textarea>
                    </div>
                </div>
            </div>
        </ng-container>

        <div 
            *ngIf="type.value === userTypeEnum.Industry || type.value === userTypeEnum.Physician"
            class="d-flex">
            <app-edit-user-card 
                title="Company name" 
                formControlName="companyName"
                [isRequired]="false">
            </app-edit-user-card>

            <div class="card not-required">
                <div class="title">Company type</div>
                <div class="content">
                    <mat-form-field>
                        <mat-label>Company type</mat-label>
                        <mat-select formControlName="companyType">
                            <mat-option 
                                *ngFor="let type of Object.values(companyTypeEnum)" 
                                [value]="type">
                                {{ type }}
                            </mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
        </div>
	</ng-container>

    <!-- * Delete / Save flow * -->
	<div class="flex-end">
		<button 
			(mousedown)="startDeleteTimeout(user.id!)"
			(mouseup)="clearDeleteTimeout()"
			(mouseout)="clearDeleteTimeout()"
			[ngClass]="{'deleting': isDeleting && activeDeletingIndex === user.id!}"
			mat-fab color="warn"
			type="button"
			matTooltip="Press to delete"
			matTooltipShowDelay="300">
			<span class="material-symbols-outlined">
				delete
			</span>
		</button>
		<button 
			[disabled]="form.invalid || isLoading"
			type="submit" 
			class="effect effect-1" 
			matTooltip="Update user"
			matTooltipShowDelay="300">
			Save
		</button>
	</div>
    <!-- * END Delete / Save flow * -->

	<mat-spinner *ngIf="isLoading"></mat-spinner>
	
</form>